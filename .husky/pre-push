# Run checks before push - only on changed files
echo "ğŸ” Running pre-push checks..."

# Allow skipping checks with SKIP_PUSH_CHECKS=1
if [ "$SKIP_PUSH_CHECKS" = "1" ]; then
  echo "âš ï¸  Skipping pre-push checks (SKIP_PUSH_CHECKS=1)"
  exit 0
fi

# Get list of changed files in the commits being pushed
CHANGED_FILES=$(git diff --name-only origin/$(git rev-parse --abbrev-ref HEAD)..HEAD)

# Filter only TypeScript/JavaScript files that still exist
TS_JS_FILES=$(echo "$CHANGED_FILES" | grep -E '\.(ts|tsx|js|jsx)$' | xargs -I {} sh -c 'test -f "{}" && echo "{}"' || true)

if [ -z "$TS_JS_FILES" ]; then
  echo "ğŸ“ No TypeScript/JavaScript files changed, skipping checks"
  exit 0
fi

echo "ğŸ“ Checking files:"
echo "$TS_JS_FILES" | sed 's/^/  - /'

# Type checking on changed files
echo "ğŸ”§ Checking TypeScript types..."
if ! npm run type-check; then
  echo "âŒ Type check failed"
  exit 1
fi

# Linting only changed files
if [ -n "$TS_JS_FILES" ]; then
  echo "ğŸ§¹ Running ESLint on changed files..."
  echo "$TS_JS_FILES" | xargs npx eslint
  if [ $? -ne 0 ]; then
    echo "âŒ ESLint failed"
    exit 1
  fi
fi

# Format checking only changed files
if [ -n "$TS_JS_FILES" ]; then
  echo "âœ¨ Checking code formatting on changed files..."
  echo "$TS_JS_FILES" | xargs npx prettier --check
  if [ $? -ne 0 ]; then
    echo "âŒ Format check failed"
    echo "ğŸ’¡ Run 'npm run format' to fix formatting issues"
    exit 1
  fi
fi

echo "âœ… All pre-push checks passed!"
echo "ğŸ’¡ To skip checks: SKIP_PUSH_CHECKS=1 git push"
